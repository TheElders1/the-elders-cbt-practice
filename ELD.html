<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Elders CBT - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://the-elders-cbt-practice.netlify.app/" />
    <meta property="og:title" content="The Elders CBT Practice - Admin Dashboard" />
    <meta property="og:description" content="Administrative control panel for The Elders CBT platform." />
    <meta property="og:image" content="https://the-elders-cbt-practice.netlify.app/ELD.png" />
</head>
<body>
    <header>
        <div class="header-content">
            <img src="ELD.png" alt="The Elders CBT Practice Logo" id="header-logo">
            <div>
                <h1>ğŸ” Admin Dashboard</h1>
                <p id="admin-welcome">System Administration & Analytics</p>
            </div>
            <div class="header-actions">
                <button id="theme-toggle" class="nav-btn">ğŸŒ™</button>
                <button id="refresh-data-btn" class="nav-btn">ğŸ”„ Refresh</button>
                <button id="logout-admin-btn" class="nav-btn danger-btn">ğŸšª Logout</button>
            </div>
        </div>
    </header>

    <main id="admin-dashboard-page">
        <!-- System Overview -->
        <section class="dashboard-section">
            <h2>ğŸ“Š System Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-quiz-attempts">0</div>
                        <div class="stat-label">Quiz Attempts</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-content">
                        <div class="stat-number" id="platform-average">0%</div>
                        <div class="stat-label">Platform Average</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ¯</div>
                    <div class="stat-content">
                        <div class="stat-number" id="active-users-week">0</div>
                        <div class="stat-label">Active This Week</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ†</div>
                    <div class="stat-content">
                        <div class="stat-number" id="total-achievements">0</div>
                        <div class="stat-label">Achievements Earned</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ”¥</div>
                    <div class="stat-content">
                        <div class="stat-number" id="longest-streak">0</div>
                        <div class="stat-label">Longest Streak</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Department Analytics -->
        <section class="dashboard-section">
            <h2>ğŸ« Department Performance</h2>
            <div class="chart-container">
                <canvas id="department-chart"></canvas>
            </div>
        </section>

        <!-- User Management -->
        <section class="dashboard-section">
            <h2>ğŸ‘¥ User Management</h2>
            <div class="admin-controls">
                <input type="text" id="user-search" placeholder="Search users..." class="search-input">
                <select id="department-filter-admin">
                    <option value="all">All Departments</option>
                    <option value="Computer Science">Computer Science</option>
                    <option value="Cyber Security">Cyber Security</option>
                    <option value="Data Science">Data Science</option>
                    <option value="Information Technology">Information Technology</option>
                    <option value="Software Engineering">Software Engineering</option>
                </select>
                <button id="export-all-data-btn" class="segment-btn">ğŸ“Š Export All Data</button>
                <button id="clear-inactive-users-btn" class="nav-btn danger-btn">ğŸ—‘ï¸ Clear Inactive</button>
            </div>
            <div id="users-table-container">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Join Date</th>
                            <th>Last Visit</th>
                            <th>Quizzes</th>
                            <th>Avg Score</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- System Analytics -->
        <section class="dashboard-section">
            <h2>ğŸ“ˆ Usage Analytics</h2>
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3>ğŸ“… Daily Activity</h3>
                    <canvas id="daily-activity-chart"></canvas>
                </div>
                <div class="analytics-card">
                    <h3>ğŸ“š Course Popularity</h3>
                    <canvas id="course-popularity-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- System Health -->
        <section class="dashboard-section">
            <h2>ğŸ”§ System Health</h2>
            <div class="health-grid">
                <div class="health-card">
                    <div class="health-icon">ğŸ’¾</div>
                    <div class="health-content">
                        <h4>Storage Usage</h4>
                        <div class="health-bar">
                            <div class="health-fill" id="storage-usage" style="width: 0%"></div>
                        </div>
                        <span id="storage-text">0 KB used</span>
                    </div>
                </div>
                <div class="health-card">
                    <div class="health-icon">âš¡</div>
                    <div class="health-content">
                        <h4>Performance</h4>
                        <div class="health-status good" id="performance-status">Excellent</div>
                        <span>Response time: <span id="response-time">< 100ms</span></span>
                    </div>
                </div>
                <div class="health-card">
                    <div class="health-icon">ğŸ”’</div>
                    <div class="health-content">
                        <h4>Security</h4>
                        <div class="health-status good">Secure</div>
                        <span>All systems operational</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recent System Events -->
        <section class="dashboard-section">
            <h2>ğŸ“‹ System Events</h2>
            <div id="system-events-container">
                <!-- System events will be populated here -->
            </div>
        </section>

        <!-- Admin Actions -->
        <section class="dashboard-section">
            <h2>âš™ï¸ Admin Actions</h2>
            <div class="admin-actions-grid">
                <button id="backup-data-btn" class="admin-action-btn">
                    <div class="action-icon">ğŸ’¾</div>
                    <div class="action-content">
                        <h4>Backup Data</h4>
                        <p>Create system backup</p>
                    </div>
                </button>
                <button id="generate-report-btn" class="admin-action-btn">
                    <div class="action-icon">ğŸ“Š</div>
                    <div class="action-content">
                        <h4>Generate Report</h4>
                        <p>Create analytics report</p>
                    </div>
                </button>
                <button id="send-announcement-btn" class="admin-action-btn">
                    <div class="action-icon">ğŸ“¢</div>
                    <div class="action-content">
                        <h4>Send Announcement</h4>
                        <p>Notify all users</p>
                    </div>
                </button>
                <button id="system-maintenance-btn" class="admin-action-btn danger">
                    <div class="action-icon">ğŸ”§</div>
                    <div class="action-content">
                        <h4>Maintenance Mode</h4>
                        <p>Enable/disable system</p>
                    </div>
                </button>
            </div>
        </section>
    </main>

    <!-- User Detail Modal -->
    <div id="user-detail-modal" class="modal" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="user-detail-name">User Details</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="user-detail-content">
                    <!-- User details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>The Elders CBT - Admin Dashboard</p>
            <div class="footer-links">
                <a href="index.html">ğŸ  Home</a>
                <a href="contact.html">ğŸ“ Contact</a>
                <a href="about.html">â„¹ï¸ About</a>
                <a href="help.html">â“ Help</a>
            </div>
        </div>
    </footer>

    <script src="main.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('admin-dashboard-page')) return;

            // Initialize admin dashboard
            initializeAdminDashboard();

            function initializeAdminDashboard() {
                loadSystemData();
                setupEventListeners();
                updateSystemHealth();
                loadSystemEvents();
                createCharts();
            }

            function loadSystemData() {
                const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                const users = Object.values(userData.users || {});
                
                updateSystemStats(users);
                displayUsersTable(users);
            }

            function updateSystemStats(users) {
                const totalUsers = users.length;
                const totalQuizAttempts = users.reduce((sum, user) => sum + (user.totalQuizzesTaken || 0), 0);
                const platformAverage = users.length > 0 ? 
                    Math.round(users.reduce((sum, user) => sum + (user.averageScore || 0), 0) / users.length) : 0;
                
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                const activeThisWeek = users.filter(user => {
                    const lastVisit = user.lastVisit ? new Date(user.lastVisit) : null;
                    return lastVisit && lastVisit > oneWeekAgo;
                }).length;

                const totalAchievements = users.reduce((sum, user) => sum + (user.achievements?.length || 0), 0);
                const longestStreak = Math.max(...users.map(user => user.longestStreak || 0), 0);

                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('total-quiz-attempts').textContent = totalQuizAttempts;
                document.getElementById('platform-average').textContent = `${platformAverage}%`;
                document.getElementById('active-users-week').textContent = activeThisWeek;
                document.getElementById('total-achievements').textContent = totalAchievements;
                document.getElementById('longest-streak').textContent = longestStreak;
            }

            function displayUsersTable(users) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="no-data">No users found</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    const joinDate = new Date(user.joinDate).toLocaleDateString();
                    const lastVisit = user.lastVisit ? new Date(user.lastVisit).toLocaleDateString() : 'Never';
                    const isActive = user.lastVisit && (new Date() - new Date(user.lastVisit)) < 7 * 24 * 60 * 60 * 1000;
                    
                    row.innerHTML = `
                        <td class="user-id">${user.id}</td>
                        <td class="user-name">
                            <strong>${user.name}</strong>
                        </td>
                        <td>${user.department || 'N/A'}</td>
                        <td>${joinDate}</td>
                        <td>${lastVisit}</td>
                        <td>${user.totalQuizzesTaken || 0}</td>
                        <td class="score-cell">
                            <span class="score-badge ${getScoreClass(user.averageScore)}">
                                ${user.averageScore || 0}%
                            </span>
                        </td>
                        <td>Level ${user.level || 1}</td>
                        <td>
                            <span class="status-badge ${isActive ? 'active' : 'inactive'}">
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>
                            <button onclick="viewUserDetails('${user.id}')" class="action-btn">ğŸ‘ï¸ View</button>
                            <button onclick="deleteUser('${user.id}')" class="action-btn danger">ğŸ—‘ï¸ Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function getScoreClass(score) {
                if (score >= 80) return 'excellent';
                if (score >= 60) return 'good';
                if (score >= 40) return 'average';
                return 'needs-improvement';
            }

            function updateSystemHealth() {
                // Calculate storage usage
                const dataSize = JSON.stringify(localStorage).length;
                const maxStorage = 5 * 1024 * 1024; // 5MB typical localStorage limit
                const usagePercent = Math.min((dataSize / maxStorage) * 100, 100);
                
                document.getElementById('storage-usage').style.width = `${usagePercent}%`;
                document.getElementById('storage-text').textContent = `${Math.round(dataSize / 1024)} KB used`;
                
                // Update performance status
                const performanceStatus = document.getElementById('performance-status');
                if (usagePercent > 80) {
                    performanceStatus.textContent = 'Warning';
                    performanceStatus.className = 'health-status warning';
                } else if (usagePercent > 90) {
                    performanceStatus.textContent = 'Critical';
                    performanceStatus.className = 'health-status critical';
                } else {
                    performanceStatus.textContent = 'Excellent';
                    performanceStatus.className = 'health-status good';
                }
            }

            function loadSystemEvents() {
                const container = document.getElementById('system-events-container');
                const events = [
                    { type: 'info', message: 'System started successfully', time: new Date().toISOString() },
                    { type: 'success', message: 'Data backup completed', time: new Date(Date.now() - 3600000).toISOString() },
                    { type: 'warning', message: 'High storage usage detected', time: new Date(Date.now() - 7200000).toISOString() }
                ];

                container.innerHTML = '';
                events.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = `system-event ${event.type}`;
                    eventEl.innerHTML = `
                        <div class="event-icon">${getEventIcon(event.type)}</div>
                        <div class="event-content">
                            <div class="event-message">${event.message}</div>
                            <div class="event-time">${new Date(event.time).toLocaleString()}</div>
                        </div>
                    `;
                    container.appendChild(eventEl);
                });
            }

            function getEventIcon(type) {
                const icons = {
                    'info': 'â„¹ï¸',
                    'success': 'âœ…',
                    'warning': 'âš ï¸',
                    'error': 'âŒ'
                };
                return icons[type] || 'â„¹ï¸';
            }

            function createCharts() {
                createDepartmentChart();
                createDailyActivityChart();
                createCoursePopularityChart();
            }

            function createDepartmentChart() {
                const ctx = document.getElementById('department-chart').getContext('2d');
                const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                const users = Object.values(userData.users || {});
                
                const departmentData = {};
                users.forEach(user => {
                    const dept = user.department || 'Unknown';
                    if (!departmentData[dept]) {
                        departmentData[dept] = { count: 0, totalScore: 0 };
                    }
                    departmentData[dept].count++;
                    departmentData[dept].totalScore += user.averageScore || 0;
                });

                const labels = Object.keys(departmentData);
                const averages = labels.map(dept => 
                    departmentData[dept].count > 0 ? 
                    Math.round(departmentData[dept].totalScore / departmentData[dept].count) : 0
                );

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average Score (%)',
                            data: averages,
                            backgroundColor: 'rgba(81, 15, 100, 0.8)',
                            borderColor: '#510F64',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            function createDailyActivityChart() {
                const ctx = document.getElementById('daily-activity-chart').getContext('2d');
                // Placeholder data - in real implementation, this would come from activity logs
                const last7Days = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                }

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Active Users',
                            data: [12, 19, 15, 25, 22, 18, 24],
                            borderColor: '#510F64',
                            backgroundColor: 'rgba(81, 15, 100, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function createCoursePopularityChart() {
                const ctx = document.getElementById('course-popularity-chart').getContext('2d');
                // Placeholder data
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['CSC121', 'MTH121', 'COS121', 'PHY121', 'GST121'],
                        datasets: [{
                            data: [30, 25, 20, 15, 10],
                            backgroundColor: [
                                '#510F64',
                                '#7B2D8E',
                                '#A64BB8',
                                '#D169E2',
                                '#FC87FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            function setupEventListeners() {
                // Search functionality
                document.getElementById('user-search').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                    const users = Object.values(userData.users || {});
                    const filteredUsers = users.filter(user => 
                        user.name.toLowerCase().includes(searchTerm) ||
                        user.id.toLowerCase().includes(searchTerm) ||
                        (user.department && user.department.toLowerCase().includes(searchTerm))
                    );
                    displayUsersTable(filteredUsers);
                });

                // Department filter
                document.getElementById('department-filter-admin').addEventListener('change', function() {
                    const department = this.value;
                    const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                    const users = Object.values(userData.users || {});
                    const filteredUsers = department === 'all' ? 
                        users : 
                        users.filter(user => user.department === department);
                    displayUsersTable(filteredUsers);
                });

                // Admin actions
                document.getElementById('export-all-data-btn').addEventListener('click', exportAllData);
                document.getElementById('clear-inactive-users-btn').addEventListener('click', clearInactiveUsers);
                document.getElementById('backup-data-btn').addEventListener('click', backupData);
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
                document.getElementById('refresh-data-btn').addEventListener('click', () => {
                    loadSystemData();
                    updateSystemHealth();
                    loadSystemEvents();
                });

                // Logout
                document.getElementById('logout-admin-btn').addEventListener('click', function() {
                    if (confirm('Are you sure you want to logout?')) {
                        window.location.href = 'index.html';
                    }
                });

                // Modal close
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.getElementById('user-detail-modal').style.display = 'none';
                });
            }

            function exportAllData() {
                const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                const dataStr = JSON.stringify(userData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `elders_cbt_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            function clearInactiveUsers() {
                if (confirm('Are you sure you want to delete all inactive users? This action cannot be undone.')) {
                    const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                    
                    Object.keys(userData.users).forEach(userId => {
                        const user = userData.users[userId];
                        const lastVisit = user.lastVisit ? new Date(user.lastVisit) : null;
                        if (!lastVisit || lastVisit < oneMonthAgo) {
                            delete userData.users[userId];
                        }
                    });
                    
                    localStorage.setItem('eldersUserData', JSON.stringify(userData));
                    loadSystemData();
                    alert('Inactive users have been removed.');
                }
            }

            function backupData() {
                exportAllData();
                alert('Backup created and downloaded successfully!');
            }

            function generateReport() {
                const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                const users = Object.values(userData.users || {});
                
                const report = {
                    generatedAt: new Date().toISOString(),
                    totalUsers: users.length,
                    totalQuizAttempts: users.reduce((sum, user) => sum + (user.totalQuizzesTaken || 0), 0),
                    platformAverage: users.length > 0 ? 
                        Math.round(users.reduce((sum, user) => sum + (user.averageScore || 0), 0) / users.length) : 0,
                    departmentBreakdown: {},
                    topPerformers: users.sort((a, b) => (b.averageScore || 0) - (a.averageScore || 0)).slice(0, 10)
                };
                
                const reportStr = JSON.stringify(report, null, 2);
                const blob = new Blob([reportStr], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Global functions
            window.viewUserDetails = function(userId) {
                const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                const user = userData.users[userId];
                
                if (!user) return;

                document.getElementById('user-detail-name').textContent = `${user.name} - Admin View`;
                document.getElementById('user-detail-content').innerHTML = `
                    <div class="user-detail-grid">
                        <div class="detail-section">
                            <h4>Basic Information</h4>
                            <p><strong>User ID:</strong> ${user.id}</p>
                            <p><strong>Name:</strong> ${user.name}</p>
                            <p><strong>Department:</strong> ${user.department || 'N/A'}</p>
                            <p><strong>Join Date:</strong> ${new Date(user.joinDate).toLocaleDateString()}</p>
                            <p><strong>Last Visit:</strong> ${user.lastVisit ? new Date(user.lastVisit).toLocaleDateString() : 'Never'}</p>
                        </div>
                        <div class="detail-section">
                            <h4>Performance Stats</h4>
                            <p><strong>Total Quizzes:</strong> ${user.totalQuizzesTaken || 0}</p>
                            <p><strong>Average Score:</strong> ${user.averageScore || 0}%</p>
                            <p><strong>Perfect Scores:</strong> ${user.perfectScores || 0}</p>
                            <p><strong>Study Streak:</strong> ${user.studyStreak || 0} days</p>
                            <p><strong>Level:</strong> ${user.level || 1}</p>
                            <p><strong>Total XP:</strong> ${user.totalXP || 0}</p>
                        </div>
                        <div class="detail-section">
                            <h4>Achievements</h4>
                            <p><strong>Total Achievements:</strong> ${user.achievements?.length || 0}</p>
                            <div class="achievement-list">
                                ${(user.achievements || []).map(achievement => `<span class="achievement-badge">${achievement}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('user-detail-modal').style.display = 'flex';
            };

            window.deleteUser = function(userId) {
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    const userData = JSON.parse(localStorage.getItem('eldersUserData') || '{}');
                    delete userData.users[userId];
                    localStorage.setItem('eldersUserData', JSON.stringify(userData));
                    loadSystemData();
                    alert('User deleted successfully.');
                }
            };
        });
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1639003968644981"
     crossorigin="anonymous"></script>
</body>
</html>
